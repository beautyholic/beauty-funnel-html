<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beautyholic – Terminassistenz</title>
  <meta name="color-scheme" content="light only" />
  <style>
    :root{
      --ink:#0f172a; --muted:#475569; --border:#e2e8f0; --card:#ffffff;
      --rose-50:#fff1f2; --rose-100:#ffe4e6; --rose-500:#f43f5e; --rose-600:#e11d48;
      --pink-50:#ffe9f7; --pink-500:#ec4899; --fuchsia-600:#c026d3;
      --bg: radial-gradient(60% 50% at 50% -10%, var(--pink-50) 0%, #fff 55%, #fff 100%);
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--ink);background:var(--bg)}
    .max {max-width: 680px; margin: 0 auto}
    .wrap{padding:16px;padding-bottom:calc(100px + env(safe-area-inset-bottom))}
    .card{background:var(--card); border:1px solid var(--border); border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .pill{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-weight:600; font-size:12px; color:#64748b}
    .trust{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .trust > span{display:inline-flex; justify-content:center; align-items:center; border-radius:16px; background:var(--rose-50); color:#be123c; border:1px solid var(--rose-100); padding:8px 10px; font-weight:600; font-size:13px}
    .offer{background:var(--rose-50); border:1px solid var(--rose-100); border-radius:18px; padding:14px}
    .chatWin{height:58vh; overflow:auto; padding:12px}
    .bubbles{display:flex; flex-direction:column; gap:8px}
    .bot{align-self:flex-start; max-width:86%; background:#fff; border:1px solid var(--border); border-radius:18px; padding:10px 12px; box-shadow:0 2px 8px rgba(0,0,0,.03)}
    .user{align-self:flex-end; max-width:86%; background:#0f172a; color:#fff; border-radius:18px; padding:10px 12px; box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .options,.slots{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
    .chip{border:1px dashed #cbd5e1; border-radius:999px; padding:9px 14px; font-weight:600; background:#fff}
    .slot{border:1px dashed #cbd5e1; border-radius:14px; padding:10px 14px; background:#fff; font-weight:600}
    .slot.active{border-style:solid}
    .typing{display:inline-flex; gap:4px; align-items:center}
    .dot{width:6px;height:6px;border-radius:999px;background:#94a3b8; animation: up .9s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes up{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-3px)}}
  </style>
</head>
<body>
  <div class="wrap max">
    <!-- Intro -->
    <section id="intro" class="card" style="padding:18px">
      <h1 style="font-size:24px;margin:0 0 8px">Porentief reine Haut. Ohne Downtime.</h1>
      <p class="muted">Buche dein <strong>Microneedling</strong> in <strong>Duisburg</strong> – schnell, freundlich und ohne Wartezeit.</p>
      <form id="leadForm" style="margin-top:16px">
        <input name="first_name" placeholder="Vorname" required style="width:100%;margin-bottom:8px;padding:10px">
        <input name="last_name" placeholder="Nachname" required style="width:100%;margin-bottom:8px;padding:10px">
        <input name="phone" placeholder="Telefon" required style="width:100%;margin-bottom:8px;padding:10px">
        <button type="submit" style="width:100%;padding:12px;background:#111827;color:#fff;border:none;border-radius:12px">Weiter</button>
      </form>
    </section>

    <!-- Chat -->
    <section id="chatCard" class="card" style="margin-top:16px;display:none;padding:0">
      <div style="padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px">
        <div style="width:36px;height:36px;border-radius:999px;background:linear-gradient(135deg,#fca5a5,#fb7185)"></div>
        <div><div style="font-weight:800">Banu</div><div class="muted" style="margin-top:-2px">Termin-Assistenz</div></div>
      </div>
      <div class="chatWin" id="chatWin" aria-live="polite">
        <div class="bubbles" id="bubbles"></div>
      </div>
      <div class="inputBar" style="display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)">
        <input id="chatInput" placeholder="Nachricht eingeben…" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:12px">
        <button id="chatSend" style="width:100px;background:#111827;color:#fff;border:none;border-radius:12px">Senden</button>
      </div>
    </section>
  </div>

<script>
/* ===== CONFIG ===== */
const N8N_LEAD_URL = "https://beautyholic.app.n8n.cloud/webhook/lead-submit";
const N8N_CHAT_URL = "https://beautyholic.app.n8n.cloud/webhook/chat-message";
const SESSION_ID = crypto.randomUUID();
let LEAD_ID = null;
let EXCLUDE_IDS = new Set();   // NEU: lokale Persistenz

/* ===== HELPERS ===== */
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
const bubbles = document.getElementById('bubbles');
function renderUser(text){ const d=document.createElement('div');d.className='user';d.textContent=text;bubbles.appendChild(d);scroll(); }
function renderBot(text){ const d=document.createElement('div');d.className='bot';d.textContent=text;bubbles.appendChild(d);scroll(); }
function renderTyping(){ const d=document.createElement('div');d.className='bot';d.innerHTML='<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';bubbles.appendChild(d);scroll();return d;}
function removeNode(n){n?.remove();}
function scroll(){document.getElementById('chatWin').scrollTop=bubbles.scrollHeight;}
async function postPlain(url,obj){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(obj)});return r.json();}

/* ===== FORM SUBMIT ===== */
document.getElementById('leadForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const data=Object.fromEntries(new FormData(e.target).entries());
  await postPlain(N8N_LEAD_URL,{session_id:SESSION_ID,form_data:data,consent:true});
  document.getElementById('intro').style.display='none';
  document.getElementById('chatCard').style.display='block';
  sendChat(""); // Chat starten
});

/* ===== SEND CHAT ===== */
async function sendChat(message,labelShown){
  const t=renderTyping();
  try{
    const payload={session_id:SESSION_ID,lead_id:LEAD_ID,message,excludeIds:Array.from(EXCLUDE_IDS)}; // NEU
    const resp=await postPlain(N8N_CHAT_URL,payload);
    removeNode(t); renderResponse(resp);
  }catch{ removeNode(t); renderBot("Verbindungsproblem – bitte kurz warten."); }
}

/* ===== RENDER RESPONSE ===== */
function renderResponse(resp){
  (resp.messages||[]).forEach(async m=>{
    if(m.type==="text") renderBot(m.text);
    else if(m.type==="options"){
      const box=document.createElement('div');box.className='bot';
      const wrap=document.createElement('div');wrap.className='options';
      (m.options||[]).forEach(o=>{
        const b=document.createElement('button');b.className='chip';b.textContent=o.label;b.dataset.id=o.id;
        b.onclick=async()=>{
          renderUser(o.label);
          wrap.querySelectorAll('button').forEach(x=>x.disabled=true);
          const r=await postPlain(N8N_CHAT_URL,{session_id:SESSION_ID,lead_id:LEAD_ID,message:o.id,excludeIds:Array.from(EXCLUDE_IDS)}); // NEU
          renderResponse(r);
        };
        wrap.appendChild(b);
      });
      box.appendChild(wrap);bubbles.appendChild(box);scroll();
    }
    else if(m.type==="slots"){
      const box=document.createElement('div');box.className='bot';
      const wrap=document.createElement('div');wrap.className='slots';
      (m.slots||[]).forEach(s=>{
        const b=document.createElement('button');b.className='slot';b.textContent=s.label;b.dataset.id=s.id;
        b.onclick=async()=>{
          renderUser(s.label);
          wrap.querySelectorAll('button').forEach(x=>x.disabled=true);
          b.classList.add('active');
          EXCLUDE_IDS.add(s.id); // NEU: Slot merken
          const r=await postPlain(N8N_CHAT_URL,{session_id:SESSION_ID,lead_id:LEAD_ID,message:s.id,excludeIds:Array.from(EXCLUDE_IDS)}); // NEU
          renderResponse(r);
        };
        wrap.appendChild(b);
      });
      box.appendChild(wrap);bubbles.appendChild(box);scroll();
    }
    if(Array.isArray(resp.lastOffered)){resp.lastOffered.forEach(id=>EXCLUDE_IDS.add(id));} // NEU
  });
}

/* ===== INPUT BAR ===== */
document.getElementById('chatSend').onclick=()=>{
  const val=document.getElementById('chatInput').value.trim();
  if(!val) return;
  renderUser(val); document.getElementById('chatInput').value='';
  sendChat(val);
};
</script>
</body>
</html>
