<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beautyholic – Terminassistenz</title>
  <style>
    body{margin:0;background:#fafafa;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .page{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:22px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px}
    h1{margin:0 0 6px;font-size:34px;line-height:1.2}
    p.sub{margin:0 0 18px;color:#475569}
    .field{margin:10px 0}
    .field input{width:100%;height:48px;border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;font-size:16px}
    .btn{width:100%;height:54px;border-radius:14px;border:0;background:#0b1426;color:#fff;font-weight:800;cursor:pointer}
    /* Chat */
    #chatCard{display:none;margin-top:16px}
    .bubble{background:#eef3f8;border-radius:14px;padding:12px 16px;margin:10px 0}
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Porentief reine Haut. Ohne Downtime.</h1>
      <p class="sub">Buche dein <b>Microneedling</b> in Duisburg – schnell, freundlich und ohne Wartezeit.</p>

      <!-- Lead-Form -->
      <form id="leadForm" novalidate>
        <div class="field"><input name="vorname" placeholder="Vorname" required /></div>
        <div class="field"><input name="nachname" placeholder="Nachname" required /></div>
        <div class="field"><input name="telefon" placeholder="Telefon" inputmode="tel" required /></div>
        <button id="leadBtn" class="btn" type="button">Weiter</button>
      </form>

      <!-- Chat -->
      <div id="chatCard">
        <div id="chatWin"></div>
        <form id="chatForm" onsubmit="return false">
          <div class="field"><input id="chatInput" placeholder="Nachricht eingeben…" /></div>
        </form>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG (n8n) ===== */
const N8N_LEAD_URL = "https://beautyholic.app.n8n.cloud/webhook-test/lead-url";
const N8N_CHAT_URL = "https://beautyholic.app.n8n.cloud/webhook/chat-url";

/* ===== State ===== */
const SESSION_ID = "sess_" + Math.random().toString(36).slice(2);
let chatBooted = false;
let firstPingDone = false;

/* ===== Dom helpers ===== */
const $ = (s)=>document.querySelector(s);
const chatWin = $("#chatWin");
function bubble(txt){ const d=document.createElement("div"); d.className="bubble"; d.textContent=txt; chatWin.appendChild(d); chatWin.scrollTop=chatWin.scrollHeight; }

async function postJSON(url, payload){
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ===== Chat boot/send ===== */
async function bootChat(){
  if(chatBooted) return;
  chatBooted = true;
  $("#leadForm").style.display = "none";
  $("#chatCard").style.display = "block";
  // einmaliger Start-Ping
  if(!firstPingDone){
    firstPingDone = true;
    await sendChat("");
  }
}

async function sendChat(message){
  try{
    const resp = await postJSON(N8N_CHAT_URL, { session_id: SESSION_ID, message });
    (resp.messages||[]).forEach(m => bubble(m.text || ""));
  }catch(e){
    console.error(e);
    bubble("Verbindung kurz gestört – bitte nochmal versuchen.");
  }
}

/* ===== Lead flow ===== */
const leadForm = $("#leadForm");

// harter Schutz: niemals echte Form-Navigation zulassen
leadForm.addEventListener("submit", (ev)=> { ev.preventDefault(); return false; });

// Enter im Formular unterbinden (führt sonst submit aus)
leadForm.addEventListener("keydown", (ev)=>{
  if(ev.key === "Enter"){ ev.preventDefault(); $("#leadBtn").click(); }
});

// CTA klick
$("#leadBtn").addEventListener("click", async ()=>{
  const data = Object.fromEntries(new FormData(leadForm).entries());
  if(!data.vorname || !data.nachname || !data.telefon){
    bubble("Bitte alle Felder ausfüllen.");
    return;
  }
  bubble("Einen Moment, ich leite dich an unsere Terminassistenz weiter …");
  try{
    await postJSON(N8N_LEAD_URL, { session_id: SESSION_ID, form_data: data, consent: true });
    await bootChat();
  }catch(e){
    console.error(e);
    bubble("Ups. Konnte die Anmeldung nicht übermitteln. Bitte neu laden.");
  }
});

/* ===== Chat input ===== */
$("#chatForm").addEventListener("submit", (ev)=>{ ev.preventDefault(); return false; });
$("#chatInput").addEventListener("keydown", async (ev)=>{
  if(ev.key === "Enter"){
    ev.preventDefault();
    const val = $("#chatInput").value.trim();
    if(!val) return;
    bubble(val);
    $("#chatInput").value = "";
    await sendChat(val);
  }
});
</script>
</body>
</html>
